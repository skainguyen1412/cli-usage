# Installation & Setup Guide

This guide walks you through installing and configuring the quota tracker CLI from scratch.

---

## Prerequisites

### Required
- **Node.js** 18+ (for TypeScript implementation)
- **npm** or **yarn** package manager

### Optional (for full functionality)
- **CLIProxyAPI** running locally or remotely (for proxy usage stats)
- Auth files for providers you want to track (generated by your IDE/tools)

---

## Installation Methods

### Method 1: Install from npm (recommended, once published)

```bash
# Global installation
npm install -g ai-quota

# Verify installation
quota --version
quota --help
```

### Method 2: Install from source (development)

```bash
# Clone the repository
git clone https://github.com/your-org/cli-usage.git
cd cli-usage

# Install dependencies
npm install

# Build the project
npm run build

# Link globally for local development
npm link

# Verify installation
quota --version
```

### Method 3: Run without installing (npx)

```bash
# Run directly with npx (downloads and runs latest version)
npx ai-quota status

# Or specify a version
npx ai-quota@latest status
```

---

## Project Setup (for development)

If you're building this CLI from scratch, here's the recommended project structure:

### Step 1: Initialize the project

```bash
# Create project directory
mkdir cli-usage
cd cli-usage

# Initialize npm project
npm init -y

# Initialize TypeScript
npm install --save-dev typescript @types/node
npx tsc --init
```

### Step 2: Install dependencies

```bash
# CLI framework
npm install commander

# HTTP client (Node 18+ has built-in fetch, but for older versions)
npm install undici

# SQLite for IDE database reading
npm install better-sqlite3
npm install --save-dev @types/better-sqlite3

# Utilities
npm install chalk         # colored terminal output
npm install cli-table3    # table formatting
npm install p-limit       # concurrency control
npm install date-fns      # date/time formatting

# Development tools
npm install --save-dev ts-node
npm install --save-dev @types/cli-table3
```

### Step 3: Configure TypeScript (`tsconfig.json`)

```json
{
  "compilerOptions": {
    "target": "ES2022",
    "module": "commonjs",
    "lib": ["ES2022"],
    "outDir": "./dist",
    "rootDir": "./src",
    "strict": true,
    "esModuleInterop": true,
    "skipLibCheck": true,
    "forceConsistentCasingInFileNames": true,
    "resolveJsonModule": true,
    "declaration": true,
    "declarationMap": true,
    "sourceMap": true
  },
  "include": ["src/**/*"],
  "exclude": ["node_modules", "dist"]
}
```

### Step 4: Set up project structure

```bash
# Create directory structure
mkdir -p src/{cli,core/{models,clients,fetchers},utils}
mkdir -p tests/{unit,integration,fixtures}

# Create main entry point
touch src/index.ts
touch src/cli/index.ts
```

**Recommended structure:**
```
cli-usage/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ index.ts                 # Main CLI entry point
â”‚   â”œâ”€â”€ cli/
â”‚   â”‚   â”œâ”€â”€ index.ts             # CLI command definitions
â”‚   â”‚   â”œâ”€â”€ commands/
â”‚   â”‚   â”‚   â”œâ”€â”€ status.ts        # 'quota status' command
â”‚   â”‚   â”‚   â”œâ”€â”€ proxy-usage.ts   # 'quota proxy-usage' command
â”‚   â”‚   â”‚   â”œâ”€â”€ doctor.ts        # 'quota doctor' command
â”‚   â”‚   â”‚   â”œâ”€â”€ export.ts        # 'quota export' command
â”‚   â”‚   â”‚   â””â”€â”€ watch.ts         # 'quota watch' command
â”‚   â”‚   â””â”€â”€ formatters/
â”‚   â”‚       â”œâ”€â”€ table.ts         # Table output formatter
â”‚   â”‚       â””â”€â”€ json.ts          # JSON output formatter
â”‚   â”œâ”€â”€ core/
â”‚   â”‚   â”œâ”€â”€ models/
â”‚   â”‚   â”‚   â”œâ”€â”€ usage-stats.ts   # UsageStats, UsageData models
â”‚   â”‚   â”‚   â””â”€â”€ quota.ts         # ProviderQuotaData, ModelQuota models
â”‚   â”‚   â”œâ”€â”€ clients/
â”‚   â”‚   â”‚   â””â”€â”€ proxy-client.ts  # CLIProxyAPI management client
â”‚   â”‚   â””â”€â”€ fetchers/
â”‚   â”‚       â”œâ”€â”€ base.ts          # ProviderFetcher interface
â”‚   â”‚       â”œâ”€â”€ codex.ts         # OpenAI/Codex fetcher
â”‚   â”‚       â”œâ”€â”€ copilot.ts       # GitHub Copilot fetcher
â”‚   â”‚       â”œâ”€â”€ claude.ts        # Claude fetcher
â”‚   â”‚       â”œâ”€â”€ antigravity.ts   # Antigravity fetcher
â”‚   â”‚       â”œâ”€â”€ gemini-cli.ts    # Gemini CLI fetcher
â”‚   â”‚       â””â”€â”€ cursor.ts        # Cursor IDE fetcher
â”‚   â”œâ”€â”€ utils/
â”‚   â”‚   â”œâ”€â”€ auth.ts              # Auth file reading/parsing
â”‚   â”‚   â”œâ”€â”€ cache.ts             # Cache management
â”‚   â”‚   â”œâ”€â”€ config.ts            # Config loading/merging
â”‚   â”‚   â”œâ”€â”€ time.ts              # Time formatting utilities
â”‚   â”‚   â””â”€â”€ logger.ts            # Logging with token redaction
â”‚   â””â”€â”€ types/
â”‚       â””â”€â”€ index.ts             # Shared TypeScript types
â”œâ”€â”€ tests/
â”‚   â”œâ”€â”€ unit/
â”‚   â”œâ”€â”€ integration/
â”‚   â””â”€â”€ fixtures/
â”‚       â””â”€â”€ auth-files/          # Sample auth files for testing
â”œâ”€â”€ docs/
â”‚   â”œâ”€â”€ plan.md
â”‚   â”œâ”€â”€ example-flow.md
â”‚   â””â”€â”€ installation.md
â”œâ”€â”€ package.json
â”œâ”€â”€ tsconfig.json
â””â”€â”€ README.md
```

### Step 5: Configure `package.json`

```json
{
  "name": "ai-quota",
  "version": "0.1.0",
  "description": "CLI tool to track quota and usage across AI tooling",
  "main": "dist/index.js",
  "bin": {
    "quota": "./dist/index.js"
  },
  "scripts": {
    "build": "tsc",
    "dev": "ts-node src/index.ts",
    "watch": "tsc --watch",
    "test": "jest",
    "lint": "eslint src --ext .ts",
    "format": "prettier --write 'src/**/*.ts'",
    "prepublishOnly": "npm run build"
  },
  "keywords": ["cli", "quota", "ai", "usage", "tracking"],
  "author": "Your Name",
  "license": "MIT",
  "engines": {
    "node": ">=18.0.0"
  },
  "dependencies": {
    "commander": "^11.1.0",
    "undici": "^6.0.0",
    "better-sqlite3": "^9.2.0",
    "chalk": "^5.3.0",
    "cli-table3": "^0.6.3",
    "p-limit": "^5.0.0",
    "date-fns": "^3.0.0"
  },
  "devDependencies": {
    "@types/node": "^20.10.0",
    "@types/better-sqlite3": "^7.6.8",
    "@types/cli-table3": "^0.6.3",
    "typescript": "^5.3.0",
    "ts-node": "^10.9.2",
    "jest": "^29.7.0",
    "@types/jest": "^29.5.0",
    "ts-jest": "^29.1.0",
    "eslint": "^8.55.0",
    "prettier": "^3.1.0"
  }
}
```

### Step 6: Create minimal CLI entry point (`src/index.ts`)

```typescript
#!/usr/bin/env node

import { Command } from 'commander';
import { version } from '../package.json';

const program = new Command();

program
  .name('quota')
  .description('Track quota and usage across AI tooling')
  .version(version);

// Placeholder commands (implement these in src/cli/commands/)
program
  .command('status')
  .description('Show provider quota status')
  .option('--format <type>', 'output format (table|json)', 'table')
  .option('--auth-dir <path>', 'auth directory path', '~/.cli-proxy-api')
  .option('--provider <name>', 'filter by provider')
  .option('--account <id>', 'filter by account')
  .option('--strict', 'fail on any error')
  .action((options) => {
    console.log('Status command (not yet implemented)');
    console.log('Options:', options);
  });

program
  .command('proxy-usage')
  .description('Show CLIProxyAPI usage stats')
  .option('--format <type>', 'output format (table|json)', 'table')
  .option('--base-url <url>', 'proxy base URL', 'http://localhost:8317')
  .action((options) => {
    console.log('Proxy usage command (not yet implemented)');
    console.log('Options:', options);
  });

program
  .command('doctor')
  .description('Diagnostic check for available data sources')
  .action(() => {
    console.log('Doctor command (not yet implemented)');
  });

program.parse();
```

### Step 7: Build and test

```bash
# Build the project
npm run build

# Link globally for testing
npm link

# Test the CLI
quota --help
quota status --help
```

---

## Configuration

### Config file locations (auto-detected)

The CLI looks for config files in these locations (in order):

1. `./quota.config.json` (current directory)
2. `~/.config/quota/config.json` (Linux/macOS XDG)
3. `~/Library/Application Support/quota/config.json` (macOS)
4. `%APPDATA%/quota/config.json` (Windows)

### Sample config file (`~/.config/quota/config.json`)

```json
{
  "authDir": "~/.cli-proxy-api",
  "baseUrl": "http://localhost:8317",
  "timeoutSeconds": 15,
  "format": "table",
  "rateLimit": {
    "maxConcurrency": 4,
    "perProvider": 2
  },
  "cache": {
    "enabled": true,
    "ttlSeconds": 300
  },
  "providers": {
    "codex": {
      "enabled": true
    },
    "copilot": {
      "enabled": true
    },
    "claude": {
      "enabled": true
    },
    "antigravity": {
      "enabled": true
    },
    "gemini-cli": {
      "enabled": true
    },
    "cursor": {
      "enabled": false,
      "dbPath": "~/Library/Application Support/Cursor/User/globalStorage/state.vscdb"
    }
  }
}
```

### Environment variables

You can also configure via environment variables:

```bash
export AIQUOTA_AUTH_DIR=~/.cli-proxy-api
export AIQUOTA_BASE_URL=http://localhost:8317
export AIQUOTA_TIMEOUT=15
export AIQUOTA_FORMAT=json
```

---

## Setting Up Provider Auth Files

The CLI reads auth files from `~/.cli-proxy-api/` (configurable). Here's how to set them up:

### Option 1: Let your IDE/tools generate them

Most IDEs and tools automatically create auth files when you log in:
- **VS Code with Copilot**: generates `github-copilot-*.json`
- **Cursor**: stores auth in SQLite database
- **Claude Desktop**: may generate `claude-*.json`

### Option 2: Manually create auth files (for testing)

Create sample auth files for testing:

```bash
# Create auth directory
mkdir -p ~/.cli-proxy-api

# Create a sample Codex auth file
cat > ~/.cli-proxy-api/codex-user@example.com.json << 'EOF'
{
  "email": "user@example.com",
  "access_token": "your-access-token-here",
  "refresh_token": "your-refresh-token-here",
  "expires_at": "2026-01-14T00:00:00Z"
}
EOF

# Set proper permissions (important for security!)
chmod 600 ~/.cli-proxy-api/*.json
```

### Option 3: Use existing auth from other tools

If you already use CLIProxyAPI or similar tools, they may have created auth files. Just point the CLI to that directory:

```bash
quota status --auth-dir /path/to/your/auth/files
```

---

## Verifying Installation

### Step 1: Check CLI is installed

```bash
quota --version
# Expected: ai-quota/0.1.0 (or similar)

quota --help
# Expected: Shows command list
```

### Step 2: Run diagnostics

```bash
quota doctor
```

**Expected output:**
- Lists config locations
- Shows discovered auth files
- Checks proxy connectivity
- Reports any issues

### Step 3: Test with a simple command

```bash
# If you have auth files configured
quota status

# If not, you'll see:
# "No provider accounts found"
```

---

## Troubleshooting

### Issue: `command not found: quota`

**Solution:**
```bash
# If installed via npm link
npm link

# If installed globally
npm install -g ai-quota

# Check npm global bin path is in PATH
npm config get prefix
# Add this to your PATH: export PATH="$(npm config get prefix)/bin:$PATH"
```

### Issue: `Permission denied` when running quota

**Solution:**
```bash
# Make the CLI executable
chmod +x dist/index.js

# Or rebuild and relink
npm run build
npm link
```

### Issue: `No provider accounts found`

**Solution:**
```bash
# Check auth directory
quota doctor

# Verify auth files exist
ls -la ~/.cli-proxy-api/

# Try specifying auth directory explicitly
quota status --auth-dir /path/to/auth/files
```

### Issue: `Cannot find module 'better-sqlite3'`

**Solution:**
```bash
# Reinstall dependencies
npm install

# If using Cursor/IDE database features, ensure better-sqlite3 is installed
npm install better-sqlite3
```

### Issue: TypeScript errors during build

**Solution:**
```bash
# Clean and rebuild
rm -rf dist node_modules
npm install
npm run build
```

---

## Development Workflow

### Running in development mode

```bash
# Run without building
npm run dev -- status

# Watch mode (auto-rebuild on changes)
npm run watch

# In another terminal, test changes
quota status
```

### Testing changes

```bash
# Run unit tests
npm test

# Run specific test file
npm test -- auth.test.ts

# Run with coverage
npm test -- --coverage
```

### Debugging

```bash
# Enable debug logging
DEBUG=quota:* quota status

# Or use Node inspector
node --inspect dist/index.js status
```

---

## Publishing (for maintainers)

### Prepare for release

```bash
# Update version
npm version patch  # or minor, major

# Build
npm run build

# Test the build
npm pack
npm install -g ./ai-quota-0.1.0.tgz
quota --version
```

### Publish to npm

```bash
# Login to npm
npm login

# Publish
npm publish

# Or publish with public access
npm publish --access public
```

### Create GitHub release

```bash
# Tag the release
git tag v0.1.0
git push origin v0.1.0

# Create release on GitHub with changelog
```

---

## Next Steps

1. âœ… Install the CLI using one of the methods above
2. âœ… Run `quota doctor` to verify setup
3. âœ… Configure auth files for providers you want to track
4. âœ… Run `quota status` to see your quota
5. âœ… (Optional) Set up a config file for custom settings
6. âœ… (Optional) Add to your shell profile for easy access

### Shell integration (optional)

Add to your `~/.zshrc` or `~/.bashrc`:

```bash
# Alias for quick quota check
alias q='quota status'

# Function to watch quota
watch-quota() {
  quota watch --interval ${1:-30}
}

# Auto-complete (if supported by your CLI framework)
# source <(quota completion)
```

---

## Support

- **Documentation**: See `docs/` directory
- **Issues**: File issues on GitHub
- **Examples**: See `docs/example-flow.md`

Happy quota tracking! ðŸš€
